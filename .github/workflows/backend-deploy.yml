name: Deploy Backend to EC2

on:
  push:
    paths:
      - 'backend/**'
      - '.github/workflows/backend-deploy.yml'
      - 'backend/Dockerfile'
      - 'backend/requirements.txt'
      - 'backend/.env*'
      - '!frontend/**'
    branches:
      - main

jobs:
  deploy:
    runs-on: self-hosted
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Create environment file
        run: |
          cd /home/ec2-user/portfolio/backend
          cat > .env << EOF
          MONGO_URL=${{ secrets.MONGO_URL }}
          GEMINI_API_KEY=${{ secrets.GEMINI_API_KEY }}
          SERPER_API_KEY=${{ secrets.SERPER_API_KEY }}
          CORS_ORIGINS=${{ secrets.CORS_ORIGINS }}
          CHROMA_HOST=${{ secrets.CHROMA_HOST }}
          CHROMA_API_KEY=${{ secrets.CHROMA_API_KEY }}
          CHROMA_TENANT=${{ secrets.CHROMA_TENANT }}
          CHROMA_DATABASE=Development
          CLOUDINARY_CLOUD_NAME=${{ secrets.CLOUDINARY_CLOUD_NAME }}
          CLOUDINARY_API_KEY=${{ secrets.CLOUDINARY_API_KEY }}
          CLOUDINARY_API_SECRET=${{ secrets.CLOUDINARY_API_SECRET }}
          DB_NAME=portfolioDB
          ENVIRONMENT=production
          EOF
          chmod 600 .env

      - name: Repopulate ChromaDB (if data files changed)
        run: |
          cd /home/ec2-user/portfolio/backend
          if git diff HEAD~1 HEAD --name-only | grep -E "(portfolio_data\.json|formatted_data\.json|fixed_data\.json)"; then
            echo "üìã Data files changed - repopulating ChromaDB..."
            python3 populate_vector_db.py
            echo "‚úÖ ChromaDB repopulated successfully!"
          else
            echo "‚ÑπÔ∏è No data file changes detected - skipping ChromaDB repopulation"
          fi

      - name: Deploy and restart backend
        run: |
          cd /home/ec2-user/portfolio
          git fetch origin main
          git reset --hard origin/main
          sudo docker rm -f portfolio-backend || true
          sudo docker build -t portfolio-backend -f backend/Dockerfile .
          sudo docker run --env-file /home/ec2-user/portfolio/backend/.env -p 8000:8000 --name portfolio-backend --restart unless-stopped -d portfolio-backend
      
      - name: Wait for container to start
        run: |
          echo "Waiting for container to start..."
          sleep 10
          sudo docker logs portfolio-backend --tail 50
      
      - name: Health check
        run: |
          echo "Running health check..."
          max_attempts=10
          attempt=0
          while [ $attempt -lt $max_attempts ]; do
            if curl -f http://localhost:8000/ > /dev/null 2>&1; then
              echo "‚úÖ Backend is healthy!"
              exit 0
            fi
            echo "Attempt $((attempt+1))/$max_attempts failed, retrying..."
            sleep 5
            attempt=$((attempt+1))
          done
          echo "‚ùå Backend health check failed!"
          exit 1
