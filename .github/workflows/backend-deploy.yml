# GitHub Actions Workflow File - Complete Learning Guide with Inline Comments
# This file defines an automated CI/CD pipeline that runs on GitHub's servers
# When you push code, it automatically builds, tests, and deploys your backend


name: Deploy Backend to EC2  # Display name shown in GitHub Actions UI

on:  # WHEN does this workflow run? (triggers section)
  push:  # Trigger on git push events
    paths:  # Only run when these files/folders change (path filters)
      - 'backend/**'  # Any file in backend/ folder
      - '.github/workflows/backend-deploy.yml'  # This workflow file itself
      - 'backend/Dockerfile'  # Docker build instructions
      - 'backend/requirements.txt'  # Python dependencies
      - 'backend/.env*'  # Environment variable files
      - '!frontend/**'  # EXCLUDE frontend changes (don't run for frontend)
    branches:  # Only run on pushes to these branches
      - main  # Production branch

jobs:  # WHAT jobs to run
  deploy:  # Job name
    runs-on: self-hosted  # Run on YOUR EC2 server

    steps:  # STEPS to execute

      - name: Checkout code
        uses: actions/checkout@v4

      - name: Create environment file
        run: |
          cd /home/ec2-user/portfolio/backend
          cat > .env << EOF
          MONGO_URL=${{ secrets.MONGO_URL }}
          GEMINI_API_KEY=${{ secrets.GEMINI_API_KEY }}
          SERPER_API_KEY=${{ secrets.SERPER_API_KEY }}
          CORS_ORIGINS=${{ secrets.CORS_ORIGINS }}
          CHROMA_HOST=${{ secrets.CHROMA_HOST }}
          CHROMA_API_KEY=${{ secrets.CHROMA_API_KEY }}
          CHROMA_TENANT=${{ secrets.CHROMA_TENANT }}
          CHROMA_DATABASE=Development
          CLOUDINARY_CLOUD_NAME=${{ secrets.CLOUDINARY_CLOUD_NAME }}
          CLOUDINARY_API_KEY=${{ secrets.CLOUDINARY_API_KEY }}
          CLOUDINARY_API_SECRET=${{ secrets.CLOUDINARY_API_SECRET }}
          DB_NAME=portfolioDB
          ENVIRONMENT=production
          RESEND_KEY=${{ secrets.RESEND_KEY }}
          RESEND_API_KEY=${{ secrets.RESEND_KEY }}
          TO_EMAIL=${{ secrets.TO_EMAIL }}
          CHATBOT_KEY=${{ secrets.CHATBOT_KEY }}
          CHATBOT=${{ secrets.CHATBOT }}
          GEMINI_BLOG_API_KEY=${{ secrets.GEMINI_BLOG_API_KEY }}
          EOF
          chmod 600 .env

      - name: Repopulate ChromaDB (if data files changed)
        run: |
          cp backend/populate_vector_db.py /home/ec2-user/portfolio/backend/populate_vector_db.py
          cd /home/ec2-user/portfolio/backend
          cat > .env << EOF
          CHROMA_API_KEY=${{ secrets.CHROMA_API_KEY }}
          CHROMA_TENANT_ID=${{ secrets.CHROMA_TENANT }}
          CHROMA_DB_NAME=Development
          GEMINI_API_KEY=${{ secrets.GEMINI_API_KEY }}
          CHATBOT_KEY=${{ secrets.CHATBOT_KEY }}
          CHATBOT=${{ secrets.CHATBOT }}
          EOF

          if git diff HEAD~1 HEAD --name-only | grep -E "(portfolio_data\.json|formatted_data\.json|fixed_data\.json)"; then
            echo "[INFO] Data files changed - repopulating ChromaDB..."
            python3 populate_vector_db.py
            echo "[SUCCESS] ChromaDB repopulated!"
          else
            echo "[INFO] No data file changes detected - skipping."
          fi

          rm -f .env

      - name: Kill process on port 8000
        run: |
          PID=$(sudo lsof -ti:8000 || true)
          if [ -n "$PID" ]; then
            sudo kill -9 $PID
            echo "Killed process $PID on port 8000."
          else
            echo "No process found on port 8000."
          fi
          exit 0

      - name: Deploy to EC2
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            cd /home/ec2-user/portfolio

            # FORCE RESET (prevents corrupted files surviving)
            git fetch --all
            git reset --hard origin/main
            git pull origin main

            # Update environment file
            cd backend
            echo "MONGO_URL=${{ secrets.MONGO_URL }}" > .env
            echo "CLOUDINARY_CLOUD_NAME=${{ secrets.CLOUDINARY_CLOUD_NAME }}" >> .env
            echo "CLOUDINARY_API_KEY=${{ secrets.CLOUDINARY_API_KEY }}" >> .env
            echo "CLOUDINARY_API_SECRET=${{ secrets.CLOUDINARY_API_SECRET }}" >> .env
            echo "GEMINI_API_KEY=${{ secrets.GEMINI_API_KEY }}" >> .env
            echo "CHROMA_API_KEY=${{ secrets.CHROMA_API_KEY }}" >> .env
            echo "CHROMA_TENANT_ID=${{ secrets.CHROMA_TENANT }}" >> .env
            echo "CHROMA_DB_NAME=Development" >> .env
            echo "CHATBOT_KEY=${{ secrets.CHATBOT_KEY }}" >> .env
            echo "CHATBOT=${{ secrets.CHATBOT }}" >> .env
            echo "GEMINI_BLOG_API_KEY=${{ secrets.GEMINI_BLOG_API_KEY }}" >> .env
            echo "SERPER_API_KEY=${{ secrets.SERPER_API_KEY }}" >> .env
            cd ..

            # HARD CLEAN Docker & Disk Space (Aggressive)
            docker stop portfolio-backend || true
            docker rm portfolio-backend || true
            docker system prune -af --volumes  # Remove all unused images, networks, build cache
            sudo apt-get clean
            sudo rm -rf /tmp/* /var/tmp/*

            # Rebuild & run
            docker build --no-cache -t portfolio-backend -f backend/Dockerfile .
            docker run -d \
              --memory=5g \
              --name portfolio-backend \
              --restart always \
              -p 8000:8000 \
              --env-file backend/.env \
              portfolio-backend

      - name: Wait for container to start
        run: |
          echo "Waiting for container to start..."
          sleep 10
          sudo docker logs portfolio-backend --tail 50

      - name: Health check
        run: |
          echo "Running health check..."
          max_attempts=60
          attempt=0
          while [ $attempt -lt $max_attempts ]; do
            if curl -f http://localhost:8000/ > /dev/null 2>&1; then
              echo "Backend is healthy!"
              exit 0
            fi
            echo "Attempt $((attempt+1))/$max_attempts: Server not ready..."
            sleep 5
            attempt=$((attempt+1))
          done

          echo "Backend health check failed!"
          sudo docker logs portfolio-backend --tail 100
          exit 1
#good